TRAIN_DATA = [
    ("WIFE, IRINA, TRANSLATED FROM ENGLISH TO RUSSIAN DURING S/A INTERVIEW WHEN NECESSARY", {'entities': [(6, 5, 'PERSON')]}),
    ("EXCELLENT, UNTIL LARRY REFUSED TO ANSWER QUESTIONS AND WALKED AWAY.", {'entities': [(17, 5, 'PERSON')]}),
    ("MARIA SPOKE SPANISH, BUT UNDERSTOOD SOME ENGLISH, HER DAUGHTER, ANA WAS AVAILABLE WHEN NEEDED FOR TRANSLATING.", {'entities': [(64, 3, 'PERSON'), (0, 5, 'PERSON')]}),
    ("MOH WAS WILLING TO DO STUDY BUT LOH WAS SA AND WAS IN SCHOOL AND STUDY FOR GRAD SCHOOL ALL DAY AND NOT AVA FOR IT --> PAT. ONLY",{'entities': [(118, 3, 'PERSON')]}),
    ("HER FULL LAST NAME IS MARINA SILVA DE AGUILA",{'entities': [(22, 21, 'PERSON')]}),
    ("SHE SAID THIS ONLY HAPPENED ONE TIME IN THE 6TH GRADE BY A TEACHER, BUT JACQUELINE BLEW IT OFF, SO IT DIDN'T AFFECT HER TOO BADLY.", {'entities': [(73, 10, 'PERSON')]}),
    ("HH MEMBER MR MORENO REFUSED EARLIER, BUT I HADN'T MADE A PERSONAL VISIT. ONCE I CONNECTED WITH HH MEMBER I THOUGHT MAYBE I HAVE CHANCE TO TURNED THIS INTO A INTERVIEW. CALLED HIM ON1/30/2021 HE ANSWE",{'entities': [(10, 9, 'PERSON')]}),
    ("MS NIKKI TRAN NEVER INTENDED TO DO INTERVIEW EVEN WHEN SHE GAVE ME A TIME I COULD CALL (9-5PM) WHEN I ASK IF SHE RECEIVED THE ADVANCE LETTER SHE SMILED BUT NEVER ANSWERED QUESTION. I CALLED 3-4 TIME",{'entities': [(0, 8, 'PERSON')]}),
    ("DO NOT HAVE ABDOMINAL PAIN OFTEN, BUT IT CAN BE SEVERE",{'entities': [(41, 3, 'PERSON'), (0, 2, 'PERSON')]}),
    ("DANIEL WAS SUPPOSED TO GET UNEMPLOYMENT (GOT A LATER) BUT THE UNEMPLOYMENT NEVER SENT HIM ANY CHECKS AND THEN LATER THEY SENT A LETTER SAYING THEY ARE STOPPING IT",{'entities': [(0, 6, 'PERSON'), (75, 2, 'PERSON'), (124, 2, 'PERSON'), (51, 4, 'PERSON')]}),
    ("INSURANCE IS THROUGH MOTHER AND LAUREN IS UNSURE ABOUT SOME QUESTIONS",{'entities':[(32, 6, 'PERSON')]}),
    ("LOH SAID NOTHING ELSE OTHER THAN MOLINA ON MEDICARE CARD.", {'entities': [(33, 6, 'PERSON')]}),
    ("I SELECTED KEITH AS PROXY BUT ALL THE QUESTIONS ARE ACTING LIKE I AM TALKING TO HIS WIFE WITH DEMEMTIA",{'entities':[(11, 5, 'PERSON')]}),
    ("ADULT SON DINO WHO LIVES IN APT ABOVE HER",{'entities':[(10, 4, 'PERSON')]}),
    ("JOSHUA IS TRANSLATING FOR HIS MOTHER",{'entities':[(0, 6, 'PERSON')]}),
    ("YANIQUE WHYTE TOLD ME SHE READ THE COPY OF THE ADVANCE LETTER I LEFT AT HER DOOR AT FIRST PV WHEN I MET HER OUTSIDE THE HU ON 4TH PV. IT'S NOT ALLOWING ME TO FILL IN HER NAME HERE.", {'entities': [(0, 13, 'PERSON')]}),
    ("ALTHOUGH SA JONATHAN POLK REFUSED EARLIER TO DO INTERVIEW I SHOULD HAVE MADE MORE ATTEMPTS TO GET THE INTERVIEW. TODAY I HAVE TO CLOSE IT OUT AS A REFUSAL TYPE A.", {'entities': [(12, 8, 'PERSON')]}),
    ("HAD TO SPEAK WITH PROXY, KAREN COMEAUX. SHE IS ALTA'S DAUGHTER (ALTA HAS DEMENTIA). KAREN'S PHONE NUMBER IS 225-402-9290",{'entities':[(47, 6, 'PERSON'), (64, 4, 'PERSON'), (25, 5, 'PERSON'), (84, 7, 'PERSON')]}),
    ("ETHAN HAS HEALTHNET TOO",{'entities':[(0, 5, 'PERSON')]}),
    ("ANNA HELPS HER HUSBAND IN HIS BUSINESS",{'entities':[(0, 4, 'PERSON'),(26, 3, 'PERSON')]}),
    ("NAME, RETARRENCE TATE NAME WAS GIVEN TO ME BY YOUNG MAN CLEARNING OUT UNIT. HE SEEMED TO THINK HE MANAGES THE PROPERTY ALTHOUGH HE DID AT FIRST CALL HIM THE OWNER.  AT ANY RATE, THIS UNIT IS CURRENTL",{'entities':[(6, 15, 'PERSON'),(143, 4, 'PERSON')]}),
    ("MENTIONED A CARETAKER KAREN MCCOY HAS THE MOST KNOWLEDGE",{'entities':[(22, 11, 'PERSON')]}),
    ("PAYAM IS NOT THE MOST KNOWLEDGEABLE ABOUT THE SC SAMMY SO I AM SPEAKING WITH LAURAN INSTEAD",{'entities':[(49, 5, 'PERSON'), (77, 6, 'PERSON')]}),
    ("TANYA DIDN'T HAVE TO PAY ANYTHING FOR INSURANCE",{'entities':[(0, 5, 'PERSON')]}),
    ("BEVERLY VAUGHN, WIFE OF JOEY VAUGHN, WAS USED AS PROXY. BOTH HAVE COVID RIGHT NOW AND MR. VAUGHN IS VERY ILL AS A RESULT AND WAS UNABLE TO CONDUCT SURVEY.", {'entities': [(0, 14, 'PERSON'), (24, 11, 'PERSON'),(87, 10, 'PERSON')]}),
    ("PATRICIA IS UNSURE ON THIS QUESTION.", {'entities': [(0, 8, 'PERSON')]}),
    ("MR KERRY PLESS WAS FIRM IN HIS REFUSAL. HE TOLD ME HE WASN'T RAISED TO ANSWER A LOT OF QUESTIONS.", {'entities': [(0, 8, 'PERSON')]}),
    ("JUSTIN AND ROXANN HAVE BEEN A COUPLE FOR THREE YEARS.  KELSEY IS ROXANN'S 20 YEAR OLD DAUGHTER FROM A PREVIOUS MARRIAGE.", {'entities': [(0, 6, 'PERSON'), (55, 6, 'PERSON'), (11, 6, 'PERSON'), (65, 8, 'PERSON')]}),
    ("FOR FIRST COUPLE MONTHS OF RAE'S LIFE, SHE WAS NOT COVERED BY HEALTH INS.", {'entities': [(27, 5, 'PERSON')]}),
    ("SON DINO, SHE DOES NOT HAVE A PHONE, HANDS ARE CRIPPLED WITH ARTHRITIS",{'entities':[(4, 4, 'PERSON')]}),
    ("DANIEL WAS SUPPOSED TO GET UNEMPLOYMENT (GOT A LETTER) BUT THE UNEMPLOYMENT NEVER SENT HIM ANY CHECKS AND THEN LATER THEY SENT A LETTER SAYING THEY ARE STOPPING IT",{'entities':[(0, 6, 'PERSON')]}),
    ("DOES NOT INCLUDE ETHAN",{'entities':[(17, 5, 'PERSON')]}), 
    ("FIELD WILL ACCEPT IN ORDER TO MOVE ON IN THE INST.",{'entities':[(64, 2, 'PERSON'), (84, 2, 'PERSON'), (52, 4, 'PERSON')]}),
    ("NOT INCLUDING BRIAN", {'entities': [(14, 5, 'PERSON')]}),
    ("HOUGH SHE FELT", {'entities': [(0, 4, 'PERSON')]}),
    ("SUSIE WAS BORN 5 WEEKS PREMATURE, SO SLIGHT DEVLOPMENTAL DELAY. TOO EARLY TO BE SURE OF ANY LASTING EFFECTS.", {'entities': [(0, 5, 'PERSON')]}),
    ("SUSIE WAS BORN 5 WEEKS PREMATURE, SO THEY ARE SLIGHTLY DELAYED DEVLOPMENTAL DELAY", {'entities': [(0, 5, 'PERSON'), (34, 2, 'PERSON')]}),
    ("ACCORDING TO MS KARINA HE HAD IT SINCE HE WAS BORN,", {'entities': [(13, 9, 'PERSON')]}),
    ("RICHARD HEALTH INSURANCE COMES OUT OF HIS PAYCHECK AND HE IS NOT HOME.", {'entities': [(0, 7, 'PERSON')]}),
    ("12PM BEN 5305917910", {'entities': [(5, 3, 'PERSON')]}),
    ("PARENT IS NOT RAUL PARENT AURELIA AND ANTONIO MENDEZ ARE THE PARENTS NOT RAUL", {'entities': [(26, 7, 'PERSON'), (38, 14, 'PERSON'), (14, 4, 'PERSON'), (73, 4, 'PERSON')]}),
    ("SHE SAID THIS ONLY HAPPENED ONE TIME IN THE 6TH GRADE BY A TEACHER, BUT JACQUELINE BLEW IT OFF, SO IT DIDN'T AFFECT HER TOO BAD.", {'entities': [(72, 11, 'PERSON')]}),
    ("KATHRYN HAS HAD A STROKE AND IS UNABLE RESPOND TO QUESTIONS", {'entities': [(0, 7, 'PERSON')]}),
    ("SEAN & ADDIE DO NOT SHARE BANK ACCOUNTS OR FILE TAXES TOGETHER, SO SEAN DOES NOT WANT TO GUESS AT HER INCOME LEVEL; ON FINANCIAL LEVEL THEY LIVE MORE LIKE ROOM MATES.  SEAN OWNS THE HOUSE & HAS THE", {'entities': [(7, 5, 'PERSON'), (0, 4, 'PERSON'), (67, 4, 'PERSON'), (168, 4, 'PERSON')]}),
    ("ED JUST RETIRED LAST MONTH", {'entities': [(0, 2, 'PERSON')]}),
    ("CHARLES HAS ALSO BLUE CROSS BLUE SHIELD. HE PAID $ 230.- SHE PAID 230 AND IN A SEPARATE PLAN WITH BLUE CROSS BLUE SHIEL CHARLES BONNER PAYS $230.- TOTAL FAMILY PAY 460.-  SON DOES NOT HAVE INSURANCE", {'entities': [(0, 7, 'PERSON'), (120, 14, 'PERSON')]}),
    ("THIS INSURANCE IS FROM A PAST EMPLOYER OF MICHAEL'S, PRINCE WILLIAM COUNTY POLICE DEPT, WHO HE RETIRED FROM AND THIS IS HIS RETIREE INSURANCE WHICH THE KIDS ARE INCLUDED ON", {'entities': [(42, 9, 'PERSON')]}),
    ("5309650529 ERICA", {'entities': [(11, 5, 'PERSON')]}),
    ("THEY ARE GRANDPARENTS. JULIA'S PARENTS DIED", {'entities': [(23, 7, 'PERSON')]}),
    ("JANICE HAS A COUPLE YEARS OF COLLEGE", {'entities': [(0, 6, 'PERSON')]}),
    ("THIS IS PETRA'S PHONE # HER DAUGHTER", {'entities': [(8, 7, 'PERSON')]}),
    ("I AM SPEAKING WITH AMBER WHO IS THE MOTHER OF THE CHILD, SHE AND HER CHILDREN LIVE WITH HER MOTHER", {'entities': [(19, 5, 'PERSON')]}),
    ("NICOLE 760-481-2646", {'entities': [(0, 6, 'PERSON')]}),
    ("I MISTAKENLY ROSTERED HER NAME AS 'NICOLE'.  HER ACTUAL NAME NICHOLE", {'entities': [(35, 6, 'PERSON'), (61, 7, 'PERSON')]}),
    ("BIOLOGICAL PARENT IS AMBER NOT LEE, LEE IS THE BIOLOGICAL GRANDPARENT", {'entities': [(21, 5, 'PERSON'), (31, 3, 'PERSON'), (36, 3, 'PERSON')]}),
    ("EDUARD HAD OPEN HEART SURGERY, ALMOST 2 YRS AGO, UNABLE TO PAY HOSPITAL BILL FROM THIS SURGERY.", {'entities': [(0, 6, 'PERSON')]}),
    ("CELL 229# BELONGS TO AURELIA", {'entities': [(21, 7, 'PERSON')]}),
    ("6268310801 OSCAR SAYS TO CALL AROUND 2PM, BUSY DOING GARDENEING AT HOME, LEFT LETTER AND CARD", {'entities': [(11, 5, 'PERSON')]}),
    ("DIDN'T HAVE MATT'S LTEL NO9.", {'entities': [(12, 6, 'PERSON')]}),
    ("ANDREW WAS CHOSEN FOR ADULT INTV & THIS IS HIS PHONE#", {'entities': [(0, 6, 'PERSON')]}),
    ("DAVID 13", {'entities': [(0, 5, 'PERSON')]}),
    ("INTERVIEW INTERPRETOR FOR THIS H.H. WAS:  CHONG OKIM GWON...SOCIAL SERVICE COORDINATOR.", {'entities': [(42, 15, 'PERSON')]}),
    ("DOUBLE-TEAMED W/FR SHA LEWIS, WHO INTERVIEWED & COMPLETED HER COPY OF THE CASE. TURNING IN MY ORIGINAL COPY TO GET OFF OF LAPTOP.", {'entities': [(19, 9, 'PERSON')]}),
    ("JWESSICA DOES HAVE ANXIETY ISSUES AT SCHOOL SO SOMETHING MAY BE GOING ON, I JUST DONT KNOW.", {'entities': [(0, 8, 'PERSON')]}),
    ("PER RESP, PH#1 IS LEILANI'S", {'entities': [(18, 9, 'PERSON')]}),
    ("CLOSE ESTIMATE - NOT SURE HOW MUCH SUE MAKES", {'entities': [(35, 3, 'PERSON')]}),
    ("THEY ARE THE BIOLOGICAL GRANDPARENTS OF HUDSON, WHO WAS BORN TO THEIR YOUNGEST SON, JOEL JR., BUT THEY HAVE HAD HIM SINCE HE WAS THREE WEEKS OLD, AND THEY ADOPTED HIM.", {'entities': [(40, 6, 'PERSON'),(84, 8, 'PERSON')]}),
    ("LEONEL TRANSLATE DUE TO IVALIA WAS NOT ABLE TO SPEAK ENGLISH", {'entities': [(0, 6, 'PERSON'), (23, 6, 'PERSON')]}),
    ("TALUS WAS CONCIEVED WITH RACHEL'S EGGS AND DONOR SPERM, JOHN AND RACHEL WERE MARRIED AT THE TIME OF HIS CONCEPTION", {'entities': [(0, 5, 'PERSON'), (56, 4, 'PERSON'), (25, 8, 'PERSON'), (65, 6, 'PERSON')]}),
    ("JACOB HIS NAME 8162739594 AFTR 5PM TUES 6", {'entities': [(0, 5, 'PERSON')]}),
    ("THE REPORT OF INCOME WASEDUARD & IRINA ONLY, VICTORIA'S INCOME IS SEPARATE FROM PARENT'S INCOME & NOT BEING REPORTED.", {'entities': [(33, 5, 'PERSON'), (45, 10, 'PERSON')]}),
    ("I DON'T KNOW BUT SINCE VICTORIA HANDED HIM HER PHONE, SHE MIGHT HAVE BEEN PRESENT", {'entities': [ (23, 8, 'PERSON')]}),
    ("PEGGY MATHIS AGREED TO DO INTERVIEW BUT THE INSTRUMENT SELECTED HH MEMBER RUBY WILBURN WHO DECIDED NOT TO PARTICIPATE. I TRIED SEVERAL TIMES TO COMPLETE THE HH SECTION WITH MS MATHIS BUT SHE STOPPED", {'entities': [(0, 12, 'PERSON'), (74, 11, 'PERSON')]}),
    ("HE DOES NOT KNOW WHAT SHEILA'S INCOME IS.", {'entities': [(22, 8, 'PERSON')]}),
    ("SHE SAID HER MIDDLE NAME IS LEE BUT THAT SHE GOES BY HER MAIDEN NAME WHICH IS DEVILLERS", {'entities': [(28, 3, 'PERSON'), (67, 10, 'PERSON')]}),
    ("LEAVE MESSAGE WITH SISTER IN LAW, MARIA CHAPA.", {'entities': [(34, 11, 'PERSON')]}),
    ("MR STATON SAID HE HAD SQUAMOUS CANCER BUT DON'T REMEMBER THE OTHER TYPE", {'entities': [(0, 9, 'PERSON')]}),
    ("FASTDATA,SEARCH FOR RESIDENTS WITH DAVID", {'entities': [(35, 5, 'PERSON')]}),
    ("MS HUNT SAID SHE IS SICK, BUT NOT INTERESTED IN DOING INTERVIEW. FAST DATA SAID THIS RESPONDENT IS 90 YEARS OLD.", {'entities': [(0, 7, 'PERSON')]}),
    ("DID NOT WANT TO ANSWER QUESTIONS ABOUT ECONOMIC SUCH AS FOOD AND INCOME OR ANY THING TO DO WITH BARBARA", {'entities': [(96, 7, 'PERSON')]}),
    ("JOSHUA SAW THEM BUT SAID HE DIDNT READ THEM- I OFFERED TO CALL HIM BACK AT A TIME THAT WAS GOOD FOR HIM SO HE HAD AN OPP TO READ THEM HE DECLINCED AND ASKED ME TO EXPLAIN IT TO HIM", {'entities': [(0, 6, 'PERSON')]}),
    ("SHE'LL BE ASKING ABOUT THIS AT NEXT MD APPOINTMENT FOR JACK.", {'entities': [(55, 4, 'PERSON')]}),
    ("MAKYIA SAID HER FATHER WOULD PROBABLY NOT PARTICIPATE", {'entities': [(0, 6, 'PERSON')]}),
    ("JOSHUA IS AGAIN ACTING AS INTERPRETER. BRUCE AND MOM ARE WITH JOSHUA.", {'entities': [(39, 5, 'PERSON'), (0, 6, 'PERSON'), (62, 6, 'PERSON')]}),
    ("SHE SAID HER MIDDLE NAME IS LEE (LEIGH?) BUT THAT SHE GOES BY HER MAIDEN NAME WHICH IS DEVILLERS", {'entities': [(28, 3, 'PERSON'), (33, 5, 'PERSON')]}),
    ("SPOKE TO THE NREIGHBOR ROBERT CUMMINGS AT 2441 AND HE USED TO LIVE ON THAT LOT 7 YRS AGO SINCE SOLD THE PROPERTY AND THE TRAILER/HOME WAS DEMOLISHED", {'entities': [(23, 15, 'PERSON')]}),
    ("JASPER WAS SEEING A PSYCHOLOGIST  REGULARLY BEFORE THE PANDEMIC BUT THAT HAS BEEN INTERRUTPTED.  HE WAS GOING BASED PARTLY ON OUR ECOURAGEMENT BUT IS SUFFICIENTLY INEDEPENDENT HE MIGHT NOT BE ENTHUSU", {'entities': [(0, 6, 'PERSON')]}),
    ("RAE IS JUST 4 MONTHS OLD", {'entities': [(0, 3, 'PERSON')]}),
    ("I AM SPEAKING WITH HIS MOTHER LAUREN", {'entities': [(30, 6, 'PERSON')]})
]
 
 
'''
Intro to NLP with spaCy (4): 
    Detecting programming languages | Episode 4: Named Entity Recognition
    https://youtu.be/IqOJU1-_Fi0
'''
 
from spacy.util import minibatch, compounding
import spacy
import datetime as dt
from spacy import displacy
import pandas as pd
from pathlib import Path
 

def create_blank_nlp(train_data):
    nlp = spacy.blank("en")
    ner = nlp.create_pipe("ner")
    nlp.add_pipe(ner, last=True)
    ner = nlp.get_pipe("ner")
    for _, annotations in train_data:
        for ent in annotations.get("entities"):
            ner.add_label(ent[2])
    return nlp
 
nlp = create_blank_nlp(TRAIN_DATA)
optimizer = nlp.begin_training()
for i in range(20):
    losses = {}
    batches = minibatch(TRAIN_DATA, size=compounding(4.0,16.0,1.001))
    for batch in batches:
        texts, annotations = zip(*batch)
        nlp.update(
			texts, # batch of texts
			annotations, # batches of annotations
			drop=0.2, # dropout - make it harder to mermorize data
			losses=losses
		)
    print(f"Lossess at iteration {i} - {dt.datetime.now()} {losses}")
 
nlp.to_disk("\\\\cdc.gov\\csp_Project\\CIPSEA_DHIS_NHIS\\Production\\NLP_DEV\\development_data\\model")

#read F7note csv file
df=(pd.read_csv("\\\\cdc.gov\\csp_Project\\CIPSEA_DHIS_NHIS\\Production\\NLP_DEV\\development_data\\evaluate.csv",
			encoding="ISO-8859-1", usecols=["text"]))			
f7notes = [_ for _ in df["text"]]

#make string objects
tmp_f7_str='\n'.join([str(elem) for elem in f7notes])
print(tmp_f7_str)

#make NLP objects
doc_f7 = nlp(tmp_f7_str)

#write dependency tree visualization
svg = displacy.render(doc_f7, style="ent", page=True)
output_path = Path("\\\\cdc.gov\\csp_Project\\CIPSEA_DHIS_NHIS\\Production\\NLP_DEV\\development_data\\evaluate.html")
output_path.open("w", encoding="utf-8").write(svg)